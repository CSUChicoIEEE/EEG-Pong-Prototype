"""
============
EEG Features
============

"""

import numpy as np
from scipy.fftpack import fft, fftfreq, fftshift
from scipy.signal import welch as sci_welch


#----------------------------------------------------------------------
def entropy(eeg):
    """Signal entropy."""

    upper = np.mean(eeg, axis=1) + 3 * np.std(eeg, axis=1)
    lower = np.mean(eeg, axis=1) - 3 * np.std(eeg, axis=1)

    bins = np.linspace(lower, upper, 20, axis=1)

    counts = [np.histogram(*xbin)[0] for xbin in zip(eeg, bins)]

    p = counts / np.sum(counts, axis=1)[:, None]
    p = [np.compress(p_ != 0, p_) for p_ in p] #remove zeros

    H = np.array([-np.sum(p_ * np.log(p_)) / len(p_) for p_ in p])
    return H


#----------------------------------------------------------------------
def energy(eeg):
    """Signal energy."""

    E = np.sum(abs(eeg ** 2), axis=1)
    return E


#----------------------------------------------------------------------
def std(eeg):
    """Standard deviation."""

    STD = np.std(eeg, axis=1)
    return STD


#----------------------------------------------------------------------
def spectrum(eeg, d=None, fs=None):
    """Spectral power density using Fourier."""

    if fs:
        d = 1 / fs

    Yf = fftshift(np.abs(fft(eeg, axis=1)))
    f = fftshift(fftfreq(Yf.shape[1], d))

    n = (Yf.shape[1] // 2)
    Yf = Yf[:, n:] * (2 / Yf.shape[1])
    f = f[n:]

    return f, Yf


#----------------------------------------------------------------------
def welch(eeg, d=None, fs=None):
    """Spectral power density using Welch's method."""

    if fs:
        d = 1 / fs

    f, p = sci_welch(eeg, 1 / d, window='flattop', nperseg=min(eeg.shape[1], 1024), scaling='spectrum')
    return f, p


